package com.runwaysdk.geodashboard.gis.persist;

import java.awt.Font;
import java.awt.GraphicsEnvironment;
import java.util.Arrays;
import java.util.Locale;

import org.json.JSONObject;

import com.runwaysdk.geodashboard.SessionParameterFacade;
import com.runwaysdk.geodashboard.gis.model.MapVisitor;
import com.runwaysdk.geodashboard.gis.model.Style;
import com.runwaysdk.geodashboard.gis.sld.SLDMapVisitor;
import com.runwaysdk.query.QueryFactory;
import com.runwaysdk.session.Session;

public class DashboardStyle extends DashboardStyleBase implements com.runwaysdk.generation.loader.Reloadable, Style
{
  private static final long serialVersionUID = 248809785;

  public DashboardStyle()
  {
    super();
  }

  @Override
  public void accepts(MapVisitor visitor)
  {
    visitor.visit(this);
  }

  /**
   * @see com.runwaysdk.business.Entity#apply()
   */
  @Override
  public void apply()
  {
    super.apply();
  }

  @Override
  public String getName()
  {
    String sessionId = Session.getCurrentSession().getId();

    String key = sessionId + "-" + this.getId();

    return SessionParameterFacade.get(key);
  }

  public void setName(String value)
  {
    String sessionId = Session.getCurrentSession().getId();

    String key = sessionId + "-" + this.getId();

    SessionParameterFacade.put(key, value);
  }

  // /**
  // * Generates the (GeoServer) name with a (TODO autogenerated string) and the prepended base, which is the layer viewName.
  // *
  // * @param base
  // */
  // public void generateName(String base)
  // {
  // this.setName(base);
  // }

  public String generateSLD()
  {
    DashboardLayer layer = this.getContainingLayer();

    SLDMapVisitor visitor = new SLDMapVisitor();
    layer.accepts(visitor);
    String sld = visitor.getSLD(layer);

    return sld;
  }

  public DashboardLayer getContainingLayer()
  {
    return this.getAllContainingLayer().getAll().get(0);
  }

  public static String[] getSortedFonts()
  {
    GraphicsEnvironment e = GraphicsEnvironment.getLocalGraphicsEnvironment();
    Locale locale = Session.getCurrentLocale();

    Font[] fonts = e.getAllFonts(); // Get the fonts
    String[] localizedFonts = new String[fonts.length];

    for (int i = 0; i < fonts.length; i++)
    {
      localizedFonts[i] = fonts[i].getFontName(locale);
    }

    Arrays.sort(localizedFonts);

    return localizedFonts;
  }

  public JSONObject toJSON()
  {
    // try {
    // JSONObject json = new JSONObject();
    //
    // return json;
    // }
    // catch (JSONException ex)
    // {
    // String msg = "Could not properly form DashboardStyle [" + this.toString() + "] into valid JSON to send back to the client.";
    // throw new ProgrammingErrorException(msg, ex);
    // }

    // Its okay to throw this here (for now) because this method is overridden with an implementation in DashboardThematicStyle
    throw new UnsupportedOperationException();
  }

  public static AggregationTypeQuery getSortedAggregations()
  {
    QueryFactory f = new QueryFactory();
    AggregationTypeQuery q = new AggregationTypeQuery(f);

    q.ORDER_BY_ASC(q.getDisplayLabel().localize());

    return q;

    // AllAggregationType[] types = AllAggregationType.values();
    // AggregationType[] aggs = new AggregationType[types.length];
    //
    // Arrays.sort(types); // sort alphabetically
    //
    // for(int i=0; i<types.length; i++)
    // {
    // aggs[i] = AggregationType.get(types[i].getId());
    // }
    //
    // return aggs;
  }

}
